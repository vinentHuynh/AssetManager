@page "/AssetEdit"

@inject Model.Asset asset
@inject NavigationManager NavigationManager
@using AssetManager.Model
@using FastMember

<div class=" main">
    <h1>Asset @asset.id</h1>

    <div class="container-fluid">

        <div class="row row-cols-1 row-cols-md-2 text-center g-4">

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" value="@accessor[asset, "id"]" readonly />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newName" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newDesc" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-control" style="width:100%" @bind="newLocId">
                                    @foreach (var loc in locList)
                                    {
                                        <option value="@loc.id">@loc.value</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-control" style="width:100%" @bind="newStatusId">
                                    @foreach (var status in statusList)
                                    {
                                        <option value="@status.id">@status.value</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-control" style="width:100%" @bind="newTypeId">
                                    @foreach (var assetType in typeList)
                                    {
                                        <option value="@assetType.id">@assetType.value</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Manufacturer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newManufacturer" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Model</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newModel" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Serial Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newSerial" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Purchase Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="date" style="width:100%" @bind="newPurchaseDate" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Warranty Expiration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="date" style="width:100%" @bind="newWarrantyExp" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Estimated Life</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="number" style="width:100%" @bind="newEstimatedLife" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Purchase Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="number" step="0.01" style="width:100%" @bind="newPurchasePrice" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newComments" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Item Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="number" style="width:100%" @bind="newItemCount" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" value="@accessor[asset, "created"]" readonly />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Created By</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-control" style="width:100%" @bind="newCreatedBy">
                                    @foreach (var user in userList)
                                    {
                                        <option value="@user.id">@user.id - @user.first_name @user.last_name</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Updated By</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-control" style="width:100%" @bind="newUpdatedBy">
                                    @foreach (var user in userList)
                                    {
                                        <option value="@user.id">@user.id - @user.first_name @user.last_name</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" value="@accessor[asset, "last_updated"]" readonly />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Photo URL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newPhotoUrl" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Path</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control" type="text" style="width:100%" @bind="newPath" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-dark">Borrowable</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input type="checkbox" style="width:100%" checked="@accessor[asset, "borrow"]" @bind-value="newBorrow" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-primary" style="width:fit-content; margin-right:10px; margin-bottom:10px;" @onclick="() => saveEdit()">Save</button>
            <button type="button" class="btn" style="width:fit-content; margin-bottom:10px;" @onclick="() => cancelEdit()">Cancel</button>

        </div>

    </div>

</div>


@code {
    static Type type = typeof(Asset);
    TypeAccessor accessor = TypeAccessor.Create(type);

    private List<Location> locList;
    private List<Status> statusList;
    private List<AssetType> typeList;
    private List<UserPartial> userList;

    private string newName;
    private string newDesc;
    private int newLocId;
    private int newStatusId;
    private int newTypeId;
    private string newManufacturer;
    private string newModel;
    private string newSerial;
    private DateTime? newPurchaseDate;
    private DateTime? newWarrantyExp;
    private int? newEstimatedLife;
    private double? newPurchasePrice;
    private string newComments;
    private int? newItemCount;
    private int? newCreatedBy;
    private int? newUpdatedBy;
    private string newPhotoUrl;
    private string newPath;
    private bool? newBorrow;

    protected override async Task OnInitializedAsync()
    {
        locList = LocationService.GetAllLocations();
        statusList = StatusService.GetAllStatuses();
        typeList = AssetTypeService.GetAllTypes();
        userList = UserPartialService.GetAllUsers();

        asset = await AssetService.GetAssetById(asset.id);

        newName = accessor[asset, "name"].ToString();
        newDesc = accessor[asset, "description"].ToString();
        newLocId = Int32.Parse(accessor[asset, "location_id"].ToString());
        newStatusId = Int32.Parse(accessor[asset, "status_id"].ToString());
        newTypeId = Int32.Parse(accessor[asset, "type_id"].ToString());
        newManufacturer = accessor[asset, "manufacturer"].ToString();
        newModel = accessor[asset, "model"].ToString();
        newSerial = accessor[asset, "serial_number"].ToString();
        newPurchaseDate = (accessor[asset, "purchase_date"] != null && accessor[asset, "purchase_date"].ToString() != DateTime.MinValue.AddYears(1899).ToString()) ? DateTime.Parse(accessor[asset, "purchase_date"].ToString()) : null;
        newWarrantyExp = (accessor[asset, "warranty_expiration"] != null && accessor[asset, "warranty_expiration"].ToString() != DateTime.MinValue.AddYears(1899).ToString()) ? DateTime.Parse(accessor[asset, "warranty_expiration"].ToString()) : null;
        newEstimatedLife = accessor[asset, "estimated_life"] != null ? Int32.Parse(accessor[asset, "estimated_life"].ToString()) : null;
        newPurchasePrice = accessor[asset, "purchase_price"] != null ? Double.Parse(accessor[asset, "purchase_price"].ToString()) : null;
        newComments = accessor[asset, "comments"].ToString();
        newItemCount = accessor[asset, "item_count"] != null ? Int32.Parse(accessor[asset, "item_count"].ToString()) : null;
        newCreatedBy = accessor[asset, "created_by"] != null ? Int32.Parse(accessor[asset, "created_by"].ToString()) : null;
        newUpdatedBy = accessor[asset, "updated_by"] != null ? Int32.Parse(accessor[asset, "updated_by"].ToString()) : null;
        newPhotoUrl = accessor[asset, "photo_url"].ToString();
        newPath = accessor[asset, "path"].ToString();
    }

    void saveEdit()
    {
        asset.name = newName;
        asset.description = newDesc;
        asset.location_id = newLocId;
        asset.status_id = newStatusId;
        asset.type_id = newTypeId;
        asset.manufacturer = newManufacturer;
        asset.model = newModel;
        asset.serial_number = newSerial;
        asset.purchase_date = newPurchaseDate;
        asset.warranty_expiration = newWarrantyExp;
        asset.estimated_life = newEstimatedLife;
        asset.purchase_price = newPurchasePrice;
        asset.comments = newComments;
        asset.item_count = newItemCount;
        asset.created_by = newCreatedBy;
        asset.updated_by = newUpdatedBy;
        asset.last_updated = DateTime.Now;
        asset.photo_url = newPhotoUrl;
        asset.path = newPath;
        asset.borrow = newBorrow;

        AssetService.EditAsset(asset);

        NavigationManager.NavigateTo("/Admin/Asset");
    }

    void cancelEdit()
    {
        NavigationManager.NavigateTo("/Admin/Asset");
    }
}
